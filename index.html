<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agenda Quincho - Centro Asturiano ğŸ‡¦ğŸ‡·</title>
  <style>
    :root {
      --azul-primario: #1e3a8a;
      --azul-gradiente: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
      --amarillo: #f59e0b;
      --blanco: #ffffff;
      --gris-fondo: #f1f5f9;
      --rojo: #ef4444;
      --verde: #10b981;
    }
    
    body { font-family: 'Segoe UI', sans-serif; background: var(--gris-fondo); color: #334155; margin: 0; padding: 0; }
    
    .header-main {
      background: var(--azul-gradiente); color: white; padding: 30px 20px;
      text-align: center; border-bottom-left-radius: 30px; border-bottom-right-radius: 30px;
    }
    .header-logo img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--amarillo); margin-bottom: 10px; }

    .container { max-width: 700px; margin: -30px auto 40px; padding: 0 20px; }
    .card { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }

    .form-group { margin-bottom: 15px; }
    label { display: block; font-weight: 600; color: var(--azul-primario); margin-bottom: 5px; font-size: 0.85rem; }
    input, select { 
      width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px; 
      font-size: 16px; box-sizing: border-box; background: #f8fafc;
    }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .grid-invitados { display: grid; grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); gap: 10px; }

    button { 
      background: var(--azul-gradiente); color: white; border: none; padding: 15px; 
      border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 10px;
    }
    .btn-volver { background: #94a3b8; margin-top: 5px; padding: 10px; }
    .btn-confirmar { background: var(--verde); font-size: 1.1rem; }
    
    .btn-copy { 
      background: #e2e8f0; color: var(--azul-primario); padding: 4px 8px; 
      font-size: 0.7rem; border-radius: 5px; width: auto; display: inline-block; margin: 0 0 0 5px;
    }

    .modal { 
      display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; 
      background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(5px); align-items: center; justify-content: center;
    }
    .modal.activa { display: flex; }
    .modal-content { background: white; padding: 25px; border-radius: 20px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }

    .item-detalle { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid #f1f5f9; }
    .total-box { background: #eff6ff; border: 2px dashed var(--azul-primario); padding: 15px; border-radius: 15px; text-align: center; margin: 15px 0; }
    .bonus { color: var(--verde); font-weight: bold; font-size: 0.9rem; }
    
    #nombreSocioDisplay { color: var(--azul-primario); text-align: center; margin: 15px 0; font-size: 1.2rem; border-bottom: 2px solid #eee; padding-bottom: 10px; }
  </style>
</head>
<body>

  <div class="header-main">
    <div class="header-logo"><img src="https://i.ibb.co/q3d6Ktzm/logo-centro-asturiano2.png"></div>
    <h1>ğŸ  Agenda Quincho</h1>
    <p>Centro Asturiano de Buenos Aires ğŸ‡¦ğŸ‡·</p>
  </div>

  <div id="modalValidacion" class="modal activa">
    <div class="modal-content" style="text-align: center;">
      <img src="https://i.ibb.co/q3d6Ktzm/logo-centro-asturiano2.png" style="width:70px;">
      <h2 style="color:var(--azul-primario)">Â¡Hola! ğŸ‘‹ Â¡Pase, Estimado Socio! El quincho te recibe con el olor a leÃ±a y las ganas de armar esta agenda. Â¡A planificar y a disfrutar</h2>
      <div class="form-group" style="text-align: left;">
        <label>NÂ° de Socio</label>
        <input type="number" id="numSocio" placeholder="Ej: 12345">
      </div>
      <div class="form-group" style="text-align: left;">
        <label>Fecha de Nacimiento</label>
        <input type="text" id="fechaNac" placeholder="DD/MM/AAAA" oninput="mascaraFecha(this)">
      </div>
      <button id="btnValidar" onclick="validarSocio()">ğŸ”¥ Ingresar ğŸªµ</button>
    </div>
  </div>

  <div class="container">
    <div id="app" class="card" style="display:none;">
      <button class="btn-volver" onclick="location.reload()">â¬…ï¸ Salir / Volver</button>
      
      <h2 id="nombreSocioDisplay"></h2>

      <div class="form-group">
        <label>âœ¨ Lugar del Evento</label>
        <select id="tipoQuincho" onchange="calcularTotal()">
          <option value="">Seleccione...</option>
          <option value="cerrado">ğŸ›– Quincho Cerrado (Max 60 pers.)</option>
          <option value="parrilla">ğŸ”¥ Parrillas Externas</option>
        </select>
      </div>

      <div class="grid-2">
        <div class="form-group">
          <label>ğŸ“… Fecha del Evento <span style="font-size: 0.75rem; color: var(--rojo); font-weight: normal;">(MÃ¡x 10 dÃ­as ant.)</span></label>
          <input type="text" id="fechaEvento" placeholder="DD/MM/AAAA" oninput="mascaraFecha(this); calcularTotal();">
          
          <label style="font-size:0.75rem; color:var(--amarillo); margin-top:5px; display:flex; align-items:center; cursor:pointer;">
             <input type="checkbox" id="esFeriado" onchange="calcularTotal()" style="width:auto; margin-right:5px;"> Â¿Es Feriado?
          </label>
        </div>
        <div class="form-group">
          <label>ğŸ‘¥ Total Invitados</label>
          <input type="number" id="totalInvitados" readonly style="background:#e2e8f0">
        </div>
      </div>

      <div class="grid-2">
        <div class="form-group">
          <label>ğŸ•’ Hora Inicio</label>
          <input type="text" id="horaInicio" placeholder="HH:MM" oninput="mascaraHora(this); calcularTotal();">
        </div>
        <div class="form-group">
          <label>ğŸ•’ Hora Fin</label>
          <input type="text" id="horaFin" placeholder="HH:MM" oninput="mascaraHora(this); calcularTotal();">
        </div>
      </div>

      <h3 style="font-size: 1rem; color: var(--azul-primario); margin-top: 10px;">ğŸ‘¥ Invitados (Precios DinÃ¡micos):</h3>
      <div class="grid-invitados">
        <div class="form-group"><label id="lbl_may">Mayores (18 a 65)</label><input type="number" id="may" value="0" min="0" oninput="calcularTotal()"></div>
        <div class="form-group"><label id="lbl_juv">Juveniles (13 a 17)</label><input type="number" id="juv" value="0" min="0" oninput="calcularTotal()"></div>
        <div class="form-group"><label id="lbl_jub">Jubilados (+65)</label><input type="number" id="jub" value="0" min="0" oninput="calcularTotal()"></div>
        <div class="form-group"><label id="lbl_men">Menores (5 a 12)</label><input type="number" id="men" value="0" min="0" oninput="calcularTotal()"></div>
        <div class="form-group"><label id="lbl_inf">Infantiles (0 a 4) (Sin Cargo)</label><input type="number" id="inf" value="0" min="0" oninput="calcularTotal()"></div>
      </div>

      <div style="background:#f8fafc; padding:15px; border-radius:12px; margin-top:10px; border: 1px solid #e2e8f0;">
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer; margin-bottom:10px;">
          <input type="checkbox" id="inflable" onchange="alertaInflable(this); calcularTotal();"> ğŸˆ Trae Inflable (+$20.000)
        </label>
        <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
          <input type="checkbox" id="cumple" onchange="alertaCumple(this); calcularTotal();"> ğŸ‰ Socio CumpleaÃ±ero (Bonif. 10 pers.)
        </label>
      </div>

      <div class="total-box">
        <div style="font-size:0.9rem; color:#64748b">Monto Total Estimado</div>
        <div style="font-size:1.8rem; font-weight:800; color:var(--azul-primario)">ARS $<span id="montoVisual">0</span></div>
      </div>

      <button class="btn-confirmar" id="btnConfirmar" disabled onclick="abrirConfirmacion()">ğŸ“ Revisar Detalle</button>
    </div>
  </div>

  <div id="modalFinal" class="modal">
    <div class="modal-content">
      <h2 style="text-align:center; color:var(--azul-primario); margin-bottom: 15px;">ğŸ“‹ Detalle de la Agenda</h2>
      <div id="desgloseFinal"></div>
      
      <div style="background:#f1f5f9; padding:15px; border-radius:12px; font-size:0.85rem; margin-top:15px; border-left: 4px solid var(--azul-primario);">
        <p><strong>ğŸ¦ Datos Bancarios:</strong></p>
        <p>CBU: 0070004720000001084140 <button class="btn-copy" onclick="copiar('0070004720000001084140')">ğŸ“‹ Copiar</button></p>
        <p>Alias: CENTRO.ASTURIANO.BA <button class="btn-copy" onclick="copiar('CENTRO.ASTURIANO.BA')">ğŸ“‹ Copiar</button></p>
        <hr>
        <p style="color:var(--rojo); font-weight:bold;">âš ï¸ Nota Importante:</p>
        <p>Si desea abonar por otro medio de pago (Efectivo/DÃ©bito), deberÃ¡ realizarlo por **Ventanilla** de administraciÃ³n hasta un dÃ­a antes del evento.</p>
      </div>

      <div class="grid-2" style="margin-top:20px;">
        <button onclick="cerrarModal('modalFinal')" style="background:#94a3b8">âš™ï¸ Editar</button>
        <button id="btnEnviar" onclick="enviarDatosFinales()" style="background:var(--verde)">ğŸ’¾ Confirmar y Guardar</button>
      </div>
    </div>
  </div>

<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxyMnbKofoiIxxratQjr99QGz_PYdaYakB37__PGiE4JKDGnCmlf5R1pYfPSSf2IisEfA/exec';

  // --- CONFIGURACIÃ“N DE TARIFAS DINÃMICAS ---
  // MARTES A JUEVES
  const PRECIOS_SEMANA = { may: 6200, juv: 5000, jub: 3900, men: 3500, inf: 0, inflable: 20000, seguridad: 20000 };
  // VIERNES, SABADO, DOMINGO Y FERIADOS
  const PRECIOS_FINDE  = { may: 7700, juv: 5500, jub: 4900, men: 4000, inf: 0, inflable: 20000, seguridad: 20000 };
  
  // Variable global para guardar las tarifas actuales
  let TARIFAS_ACTUALES = PRECIOS_FINDE; 

  let socioNombre = "";
  let descuentoAplicado = 0;
  let seguridadActiva = false;

  function mascaraFecha(i) {
    let v = i.value.replace(/\D/g,'');
    if (v.length > 2) v = v.substring(0,2) + '/' + v.substring(2);
    if (v.length > 5) v = v.substring(0,5) + '/' + v.substring(5,9);
    i.value = v;
  }

  function mascaraHora(i) {
    let v = i.value.replace(/\D/g,'');
    if (v.length > 2) v = v.substring(0,2) + ':' + v.substring(2,4);
    i.value = v;
  }

  function copiar(texto) {
    navigator.clipboard.writeText(texto).then(() => {
      alert("âœ… Copiado: " + texto);
    });
  }

  function validarSocio() {
    const socio = document.getElementById('numSocio').value;
    const fechaRaw = document.getElementById('fechaNac').value;
    const btn = document.getElementById('btnValidar');

    if (!socio || !fechaRaw) {
      alert("Por favor completa ambos campos");
      return;
    }

    const partes = fechaRaw.split('/');
    if (partes.length === 3) {
      const dia = partes[0]; 
      const mes = partes[1]; 
      const anio = partes[2]; 
      
      const fechaLimpia = `${dia}/${mes}/${anio}`;

      btn.innerText = "â³ Verificando...";
      btn.disabled = true;

      fetch(`${APPS_SCRIPT_URL}?action=validarSocio&numSocio=${socio}&fechaNac=${fechaLimpia}`)
        .then(r => r.json())
        .then(res => {
          if (res.exito) {
            socioNombre = res.nombre;
            document.getElementById('nombreSocioDisplay').innerText = "Socio/a: " + socioNombre;
            document.getElementById('modalValidacion').classList.remove('activa');
            document.getElementById('app').style.display = 'block';
            // Iniciar con precios de fin de semana por defecto
            actualizarLabelsPrecios(PRECIOS_FINDE);
          } else {
            alert("âŒ " + res.mensaje);
          }
        })
        .catch(e => alert("Error de conexiÃ³n"))
        .finally(() => {
          btn.innerText = "ğŸš€ Ingresar";
          btn.disabled = false;
        });
    } else {
      alert("Formato de fecha incorrecto");
    }
  }

  // --- LÃ“GICA DE PRECIOS POR DÃA ---
  function actualizarLabelsPrecios(tarifas) {
    document.getElementById('lbl_may').innerText = `Mayores (18 a 65) ($${tarifas.may.toLocaleString('es-AR')})`;
    document.getElementById('lbl_juv').innerText = `Juveniles (13 a 17) ($${tarifas.juv.toLocaleString('es-AR')})`;
    document.getElementById('lbl_jub').innerText = `Jubilados (+65) ($${tarifas.jub.toLocaleString('es-AR')})`;
    document.getElementById('lbl_men').innerText = `Menores (5 a 12) ($${tarifas.men.toLocaleString('es-AR')})`;
  }

  function calcularTotal() {
    const fechaInput = document.getElementById('fechaEvento').value;
    const esFeriadoCheck = document.getElementById('esFeriado').checked;

    // Detectar dÃ­a de la semana
    TARIFAS_ACTUALES = PRECIOS_SEMANA; // Por defecto Martes-Jueves
    
    if (fechaInput && fechaInput.length === 10) {
      const [dia, mes, anio] = fechaInput.split('/').map(Number);
      const fechaObj = new Date(anio, mes - 1, dia);
      const diaSemana = fechaObj.getDay(); // 0=Domingo, 1=Lunes, ... 5=Viernes, 6=Sabado
      
      // Si es Viernes(5), SÃ¡bado(6) o Domingo(0) O si marcaron "Es Feriado"
      if (diaSemana === 0 || diaSemana === 5 || diaSemana === 6 || esFeriadoCheck) {
        TARIFAS_ACTUALES = PRECIOS_FINDE;
      }
    } else {
        // Si no hay fecha, mostramos precio FINDE por seguridad/default
        TARIFAS_ACTUALES = PRECIOS_FINDE;
    }

    // Actualizar visualmente los textos
    actualizarLabelsPrecios(TARIFAS_ACTUALES);

    // --- CÃLCULOS ---
    const hFin = document.getElementById('horaFin').value;
    let counts = {
      may: parseInt(document.getElementById('may').value) || 0,
      juv: parseInt(document.getElementById('juv').value) || 0,
      jub: parseInt(document.getElementById('jub').value) || 0,
      men: parseInt(document.getElementById('men').value) || 0,
      inf: parseInt(document.getElementById('inf').value) || 0
    };
    
    const totalInv = Object.values(counts).reduce((a, b) => a + b, 0);
    document.getElementById('totalInvitados').value = totalInv;

    let subtotalInvitados = 
        (counts.may * TARIFAS_ACTUALES.may) + 
        (counts.juv * TARIFAS_ACTUALES.juv) + 
        (counts.jub * TARIFAS_ACTUALES.jub) + 
        (counts.men * TARIFAS_ACTUALES.men);
    
    descuentoAplicado = 0;
    if (document.getElementById('cumple').checked) {
      let cupo = 10;
      const orden = ['may', 'juv', 'jub', 'men'];
      orden.forEach(tipo => {
        if (cupo > 0 && counts[tipo] > 0) {
          let descontar = Math.min(counts[tipo], cupo);
          descuentoAplicado += (descontar * TARIFAS_ACTUALES[tipo]);
          cupo -= descontar;
        }
      });
    }

    let total = subtotalInvitados - descuentoAplicado;

    seguridadActiva = false;
    if (hFin.includes(':')) {
      let [hh, mm] = hFin.split(':').map(Number);
      let minTotales = (hh * 60) + mm;
      if (minTotales >= 10 && minTotales <= 300) {
        total += TARIFAS_ACTUALES.seguridad;
        seguridadActiva = true;
        if (!window.seguridadAlerta) {
          alert("ğŸ‘® SEGURIDAD:\nPara reuniones pasadas las 00:00hs se tiene que abonar la seguridad correspondiente a 5 horas ($20.000).");
          window.seguridadAlerta = true;
        }
      } else { window.seguridadAlerta = false; }
    }

    if (document.getElementById('inflable').checked) total += TARIFAS_ACTUALES.inflable;

    document.getElementById('montoVisual').innerText = total.toLocaleString('es-AR');
    document.getElementById('btnConfirmar').disabled = (totalInv === 0);
  }

  function alertaInflable(cb) {
    if(cb.checked) alert("ğŸˆ AVISO INFLABLE:\n\nEn los casos que se desea traer inflable se tendria que abonar locacion $20.000, hasta 1 dia previo al evento, ART y/o seguro de accidentes personales con clÃ¡usula de no repeticiÃ³n a nombre del CENTRO ASTURIANO DE BENOS AIRES Cuit: 30-54586286-3");
  }

  function alertaCumple(cb) {
    if(cb.checked) alert("ğŸ‰ AVISO CUMPLEAÃ‘ERO:\n\nbeneficio unico para el socio cumpleaÃ±ero para ser uso por unica vez desde la fecha de nacimiento hasta 30 dias corridos.");
  }

  function abrirConfirmacion() {
    const fechaInput = document.getElementById('fechaEvento').value;
    
    // 1. Validar que la fecha estÃ© completa
    if (!fechaInput || fechaInput.length < 10) {
      alert("âš ï¸ Por favor, ingresÃ¡ una fecha vÃ¡lida (DD/MM/AAAA)");
      return;
    }

    const [dia, mes, anio] = fechaInput.split('/').map(Number);
    const fechaElegida = new Date(anio, mes - 1, dia);
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);

    const milisegundosPorDia = 24 * 60 * 60 * 1000;
    const diffDias = Math.floor((fechaElegida - hoy) / milisegundosPorDia);

    // --- VALIDACIONES ---
    if (diffDias < 0) {
      alert("ğŸš« No se pueden realizar reservas para fechas pasadas.");
      return;
    }

    if (diffDias > 10) {
      alert(`ğŸš« Solo se permiten reservas con un mÃ¡ximo de 10 dÃ­as de antelaciÃ³n.\n\nHoy es ${hoy.toLocaleDateString('es-AR')}, podÃ©s reservar hasta el ${(new Date(hoy.getTime() + 10 * milisegundosPorDia)).toLocaleDateString('es-AR')}.`);
      return;
    }

    const segVal = seguridadActiva ? TARIFAS_ACTUALES.seguridad : 0;
    const infVal = document.getElementById('inflable').checked ? TARIFAS_ACTUALES.inflable : 0;

    let html = `
      <div class="item-detalle"><span>Socio:</span> <span>${socioNombre}</span></div>
      <div class="item-detalle"><span>ğŸ“… Fecha:</span> <span>${fechaInput}</span></div>
      <div class="item-detalle"><span>ğŸ•’ Horario:</span> <span>${document.getElementById('horaInicio').value} a ${document.getElementById('horaFin').value}</span></div>
      <div class="item-detalle"><span>ğŸ‘¥ Invitados:</span> <span>${document.getElementById('totalInvitados').value}</span></div>
      <div class="item-detalle"><span>ğŸˆ Inflable:</span> <span>$${infVal.toLocaleString('es-AR')}</span></div>
      <div class="item-detalle"><span>ğŸ‘® Seguridad:</span> <span>$${segVal.toLocaleString('es-AR')}</span></div>
    `;

    if(descuentoAplicado > 0) {
      html += `<div class="item-detalle bonus"><span>ğŸ BonificaciÃ³n 10p:</span> <span>- $${descuentoAplicado.toLocaleString('es-AR')}</span></div>`;
    }

    html += `<div class="total-box"><b>TOTAL FINAL: ARS $${document.getElementById('montoVisual').innerText}</b></div>`;

    document.getElementById('desgloseFinal').innerHTML = html;
    document.getElementById('modalFinal').classList.add('activa');
  }

  function enviarDatosFinales() {
    const btn = document.getElementById('btnEnviar');
    btn.innerText = "â³ Guardando...";
    btn.disabled = true;

    const numSocio = document.getElementById('numSocio').value;
    const tipo = document.getElementById('tipoQuincho').value;
    const fecha = document.getElementById('fechaEvento').value;
    const hIni = document.getElementById('horaInicio').value;
    const hFin = document.getElementById('horaFin').value;
    const invitados = document.getElementById('totalInvitados').value;
    const totalStr = document.getElementById('montoVisual').innerText;
    const detalle = `May: ${document.getElementById('may').value}, Juv: ${document.getElementById('juv').value}, Jub: ${document.getElementById('jub').value}, Men: ${document.getElementById('men').value}`;

    const urlFinal = `${APPS_SCRIPT_URL}?action=guardarAgenda&numSocio=${encodeURIComponent(numSocio)}&socio=${encodeURIComponent(socioNombre)}&tipo=${encodeURIComponent(tipo)}&fechaEvento=${encodeURIComponent(fecha)}&horaInicio=${encodeURIComponent(hIni)}&horaFin=${encodeURIComponent(hFin)}&totalInvitados=${encodeURIComponent(invitados)}&total=${encodeURIComponent(totalStr)}&listaInvitados=${encodeURIComponent(detalle)}`;

    fetch(urlFinal, { method: 'GET' })
      .then(r => r.json())
      .then(res => {
        if (res.exito) {
          alert("âœ… Â¡Agenda guardada con Ã©xito!: para el disfrute del beneficio de agenda el socio debe estar al dia con su cuota.");
          window.open(`https://wa.me/5491151585858?text=Hola! EnvÃ­o comprobante de reserva Quincho de ${socioNombre}`, '_blank');
          location.reload();
        } else {
          alert("âŒ Error: " + res.mensaje);
        }
      })
      .catch(e => alert("âš ï¸ Error al conectar. Intente nuevamente."))
      .finally(() => {
        btn.innerText = "ğŸ’¾ Confirmar y Guardar";
        btn.disabled = false;
      });
  }

  function cerrarModal(id) { document.getElementById(id).classList.remove('activa'); }
</script>
</body>
</html>
